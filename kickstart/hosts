#!/usr/bin/env ruby

require 'hiera'
require 'json'

MyHiera = Hiera.new(:config => './hiera.yaml')
Datadir = MyHiera.config[:yaml][:datadir]
begin
    Domain = MyHiera.lookup('ansible', {}, {})['domain']
rescue
    puts 'No domain found'
    exit 1
end

inventory = {
    'all' => {
        'hosts' => [],
        'vars' => MyHiera.lookup('ansible', {}, {}),
    },
    '_meta' => {
        'hostvars' => {},
    },
}

Dir.glob(Datadir + '/*').each do |file_name|
    next unless file_name.match /^.*\/([a-z]+)\.#{Domain}.yaml$/
    host_name = $1
    host_vars = MyHiera.lookup('ansible', {}, {'::fqdn' => "#{host_name}.#{Domain}"})
    inventory['all']['hosts'] << host_name
    inventory['_meta']['hostvars'][host_name] = host_vars
end

puts inventory.to_json

